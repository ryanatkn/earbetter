import{a as m,t as y,c as ae,s as ce,d as Ke,e as Re,h as Ue}from"../chunks/disclose-version.Bm39VVKR.js";import{C as xe,D as We,B as Je,aB as Ye,K as Ze,J as Fe,L as He,U as Oe,p as O,t as u,a as Q,c as _,s as h,g as t,r as n,d as i,f as U,a4 as Me,j as M,_ as T,Y as ye,$ as Qe,u as ke,aC as we,a0 as Ve,n as Xe}from"../chunks/index-client.CU3AkS2I.js";import{i as L,p as B,a as pe}from"../chunks/props.Du8wBp8y.js";import{e as me,s as W,i as ge,b as j,t as te,p as $e}from"../chunks/string.zkJUj9Mg.js";import{t as ue,u as et,G as tt,v as at,x as H,y as lt,f as Te,j as st,n as je,w as qe,k as ze,i as it,s as R,A as Be}from"../chunks/index.C8uV2S4O.js";import{M as rt,b as nt,P as vt,B as _t}from"../chunks/Back_Button.DXPJ5tz-.js";import{b as Ie}from"../chunks/this.BDv6f66L.js";import{L as ot}from"../chunks/Level_Stats_Summary.BwPUQ8p1.js";function Le(b,e,s){xe&&We();var g=b,v=Oe,d;Je(()=>{Ye(v,v=e())&&(d&&Ze(d),d=Fe(()=>s(g)))}),xe&&(g=He)}var dt=y('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),ct=y('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function ut(b,e){O(e,!0);const s=(r,l,o,c)=>r==="complete"?"var(--lighten_5)":o[c]?l&&c===l.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",g=i(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var v=ct(),d=_(v);me(d,17,()=>({length:e.level.level_data.trial_count}),ge,(r,l,o)=>{var c=dt();const k=i(()=>s(e.level.status,e.level.trial,e.level.trials,o));u(()=>j(c,"background-color",t(k))),m(r,c)});var z=h(d,2);W(z,"aria-valuemin",0),W(z,"aria-valuemax",100),u(()=>W(z,"aria-valuenow",Math.floor(t(g)*100))),n(v),u(()=>j(v,"--progress_bar_percent",t(g))),m(b,v),Q()}var mt=y('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),gt=y('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function ft(b,e){O(e,!0);const s=i(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),g=(r,l,o)=>r==="showing_failure_feedback"?"transparent":r==="complete"||r==="showing_success_feedback"?"var(--lighten_4)":l===o?"var(--lighten_3)":o!==null&&l<o?"var(--lighten_2)":"transparent",v=i(()=>{var r,l;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((r=e.level.trial)==null?void 0:r.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((l=e.level.trial)==null?void 0:l.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=ae(),z=U(d);L(z,()=>e.level.trial,r=>{var l=gt(),o=_(l);me(o,17,()=>({length:e.level.trial.sequence.length}),ge,(k,P,C)=>{var S=mt();const N=i(()=>g(e.level.status,C,t(s)));u(()=>j(S,"background-color",t(N))),m(k,S)});var c=h(o,2);W(c,"aria-valuemin",0),W(c,"aria-valuemax",100),u(()=>W(c,"aria-valuenow",Math.floor(t(v)*100))),n(l),u(()=>j(l,"--progress_bar_percent",t(v))),ue(3,l,()=>et),m(r,l)}),m(b,d),Q()}var bt=y('<div class="burst-item svelte-zx8aeo"> </div>'),ht=y('<div class="burst svelte-zx8aeo"></div>');function Se(b,e){O(e,!0);const s=B(e,"duration",3,2e3),g=B(e,"x_radius",3,250),v=B(e,"y_radius",3,250),d=B(e,"scale_min",3,1),z=B(e,"scale_max",3,tt),r=B(e,"hue_rotation_min",3,0),l=B(e,"hue_rotation_max",3,0),o=B(e,"start_rotation_min",3,0),c=B(e,"start_rotation_max",3,359),k=B(e,"end_rotation_min",3,0),P=B(e,"end_rotation_max",3,359);let C=T(!1),S;Me(()=>(S=setTimeout(()=>M(C,!0),s()),()=>clearTimeout(S)));var N=ae(),le=U(N);L(le,()=>!t(C),se=>{var I=ht();me(I,21,()=>({length:e.count}),ge,(V,ie)=>{var q=bt();const re=i(()=>`${H(-g(),g())??""}px`);u(()=>j(q,"--target_x",t(re)));const X=i(()=>`${H(-v(),v())??""}px`);u(()=>j(q,"--target_y",t(X)));const J=i(()=>lt(d(),z()));u(()=>j(q,"--scale",t(J)));const ne=i(()=>`${H(o(),c())??""}deg`);u(()=>j(q,"--start_rotation",t(ne)));const p=i(()=>`${H(k(),P())??""}deg`);u(()=>j(q,"--end_rotation",t(p)));const $=i(()=>`${H(r(),l())??""}deg`);u(()=>j(q,"--hue_rotation",t($)));var K=_(q);u(()=>ce(K,at(e.items))),n(q),m(V,q)}),n(I),u(()=>j(I,"--animation_timer",`${s()??""}ms`)),m(se,I)}),m(b,N),Q()}const xt=(b,e,s)=>{b.target===t(e)&&s.level.retry_trial()};var yt=y('<div class="size_xl3 text_align_center">flawless run!</div>'),kt=y('<div class="size_xl3"> </div> <div> </div>',1),wt=(b,e)=>e.exit_level(),jt=(b,e)=>e.level.reset(),qt=y('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),zt=y('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),Bt=y('<!> <div class="level svelte-16m1rsw" aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div class="feedback svelte-16m1rsw"><!> <!></div></div>',1);function It(b,e){O(e,!0);const s=Te.get(),g=st.get();let v=T(void 0);const d=i(()=>e.level.level_data),z=i(()=>{var a;return(a=e.level.trial)==null?void 0:a.guessing_index}),r=i(()=>e.level.status==="presenting_prompt"?null:s.playing_notes),l=i(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Me(()=>{e.level.start()});const o=a=>{console.log("press note key",a),e.level.guess(a)};let c=T(0),k=T(null);const P=i(()=>e.level.status==="waiting_for_input"),C=i(()=>e.level.status==="showing_success_feedback"),S=i(()=>e.level.status==="showing_failure_feedback"),N=i(()=>e.level.status==="complete");ye(()=>{t(C)&&ke(le)}),ye(()=>{t(S)&&ke(se)});const le=()=>{we(c),M(k,"success"),q()},se=()=>{we(c),M(k,"failure"),q()};let I=T(void 0),V=T(0),ie=T(0);const q=()=>{if(!t(I))return;const a=e.level.last_guess;if(a===null)return;const x=t(I).querySelector(`[data-note="${a}"]`);if(!x)return;const w=x.getBoundingClientRect();M(V,pe(w.x)),M(ie,w.y+w.height/2)},re=i(()=>t(P)&&t(z)===0),X=20;let J=T(void 0);const ne=a=>{if(!(it(a.target)||a.ctrlKey||a.shiftKey||a.altKey||a.metaKey))switch(a.key){case"r":{R(a),e.level.reset();return}case" ":switch(e.level.status){case"complete":{R(a),e.exit_level();return}default:{R(a),e.level.retry_trial();return}}case"d":{R(a),e.level.guess_correctly();return}case"a":{R(a),e.level.guess_incorrectly();return}case"w":{R(a),e.level.win();return}}};var p=Bt();Re("keydown",Qe,ne,!0);var $=U(p);rt($,{get midi_access(){return s.midi_access},onnotestart:(a,x)=>{e.level.status==="complete"?je(s,g(),a,qe(s.volume,x),s.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(a))},onnotestop:a=>{ze(a)}});var K=h($,2);Ie(K,a=>M(J,a),()=>t(J)),K.__click=[xt,J,e];var ve=_(K),Pe=_(ve);ut(Pe,{get level(){return e.level}}),n(ve);var _e=h(ve,2),Ce=_(_e);ft(Ce,{get level(){return e.level}}),n(_e);var Y=h(_e,2);Ie(Y,a=>M(I,a),()=>t(I)),j(Y,"padding",`${X}px`);var Ne=_(Y);L(Ne,()=>t(v),a=>{var x=i(()=>t(v)-X*2),w=i(()=>{var f;return(f=e.level.trial)==null?void 0:f.valid_notes}),A=i(()=>e.level.status==="waiting_for_input"?f=>o(f):e.level.status==="complete"?f=>je(s,g(),f,qe(s.volume,null),s.instrument):void 0),D=i(()=>e.level.status==="complete"?f=>ze(f):void 0);vt(a,{get width(){return t(x)},get min_note(){return t(d).min_note},get max_note(){return t(d).max_note},get enabled_notes(){return t(w)},get pressed_keys(){return t(r)},get highlighted_keys(){return t(l)},get onpress(){return t(A)},get onrelease(){return t(D)}})}),n(Y);var Z=h(Y,2),fe=_(Z);L(fe,()=>t(N),a=>{var x=qt(),w=_(x),A=_(w),D=h(A,2),f=_(D),E=_(f);L(E,()=>e.level.mistakes===0,oe=>{var ee=yt();m(oe,ee)},oe=>{var ee=kt(),de=U(ee),Ee=_(de);n(de);var he=h(de,2),Ge=_(he);u(()=>ce(Ge,`mistake${$e(e.level.mistakes)??""} this run`)),n(he),u(()=>ce(Ee,e.level.mistakes)),m(oe,ee)}),n(f);var G=h(f,2),F=_(G);ot(F,{get level_data(){return t(d)},get level_stats(){return e.level_stats}}),n(G),n(D);var be=h(D,2);be.__click=[wt,e];var De=h(be,2);De.__click=[jt,e],n(w),n(x),ue(1,A,()=>Be,()=>({duration:3e3})),ue(3,w,()=>Be),m(a,x)});var Ae=h(fe,2);L(Ae,()=>t(k)!==null,a=>{var x=zt(),w=_(x),A=_(w);L(A,()=>t(k)==="success",f=>{var E=ae(),G=U(E);Le(G,()=>t(c),F=>{Se(F,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),m(f,E)});var D=h(A,2);L(D,()=>t(k)==="failure",f=>{var E=ae(),G=U(E);Le(G,()=>t(c),F=>{Se(F,{count:5,items:["🦜","⁉","❔","❌"]})}),m(f,E)}),n(w),n(x),u(()=>j(w,"transform",`translate3d(${t(V)??""}px, ${t(ie)??""}px, 0)`)),m(a,x)}),n(Z),n(K),u(()=>{te(K,"initial",t(re)),te(Z,"success",t(C)),te(Z,"failure",t(S)),te(Z,"complete",t(N))}),nt(K,"clientWidth",a=>M(v,a)),m(b,p),Q()}Ke(["click"]);var Lt=y('<div class="level svelte-1jfpjrg"><!></div>'),St=y('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Kt=y('<main class="svelte-1jfpjrg"><!> <!></main>');function Gt(b,e){O(e,!0);const s=Te.get(),g=i(()=>{var r;return(r=s.selected_project_data)==null?void 0:r.level_stats});var v=Kt();Ue(r=>{Ve.title="Earbetter trainer level"});var d=_(v);_t(d,{get onclick(){return s.exit_level}});var z=h(d,2);L(z,()=>s.level&&t(g),r=>{var l=Lt(),o=_(l);It(o,{get level(){return s.level},get level_stats(){return t(g)},get exit_level(){return s.exit_level}}),n(l),m(r,l)},r=>{var l=St(),o=_(l),c=h(_(o));c.__click=function(...k){var P;(P=s.exit_level)==null||P.apply(this,k)},Xe(),n(o),n(l),m(r,l)}),n(v),m(b,v),Q()}Ke(["click"]);export{Gt as component};
