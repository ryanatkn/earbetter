import{t as b,a as c,c as de,s as fe,d as Ae,e as Ye,h as pe}from"../chunks/BkDeQcoF.js";import{i as qe,j as $e,h as et,aF as tt,x as at,w as lt,y as st,U as it,p as se,c as v,t as T,s as f,r,g as a,d as u,a as ie,f as J,W as Ee,F as N,N as P,M as ze,u as Ie,aG as Be,$ as rt,Q as nt,n as vt}from"../chunks/D3PyqNrN.js";import{i as L,p as z}from"../chunks/DZ3TPD6y.js";import{e as xe,d as G,i as be,s as O,c as Me,p as _t}from"../chunks/D8xi9fHe.js";import{t as le,u as ot,G as dt,v as ae,x as ct,y as ut,f as Fe,j as mt,n as Se,o as Le,w as Te,i as gt,s as H,A as Ke,B as Ne}from"../chunks/BZsgZKit.js";import{M as ft,b as xt,P as bt,B as ht}from"../chunks/Lah5fwwW.js";import{b as Pe}from"../chunks/DADDcQB6.js";import{L as yt}from"../chunks/DzpRWNJz.js";function Ge(x,e,s){qe&&$e();var m=x,_=it,d,k=tt;et(()=>{k(_,_=e())&&(d&&at(d),d=lt(()=>s(m)))}),qe&&(m=st)}var kt=b('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),wt=b('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function jt(x,e){se(e,!0);const s=(n,l,i,o)=>n==="complete"?"var(--lighten_5)":i[o]?l&&o===l.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",m=u(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var _=wt();let d;var k=v(_);xe(k,17,()=>({length:e.level.level_data.trial_count}),be,(n,l,i)=>{var o=kt();let w;T(h=>w=G(o,"",w,{"background-color":h}),[()=>s(e.level.status,e.level.trial,e.level.trials,i)]),c(n,o)});var q=f(k,2);O(q,"aria-valuemin",0),O(q,"aria-valuemax",100),r(_),T(n=>{d=G(_,"",d,{"--progress_bar_percent":a(m)}),O(q,"aria-valuenow",n)},[()=>Math.floor(a(m)*100)]),c(x,_),ie()}var qt=b('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),zt=b('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function It(x,e){se(e,!0);const s=u(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),m=(n,l,i)=>n==="showing_failure_feedback"?"transparent":n==="complete"||n==="showing_success_feedback"?"var(--lighten_4)":l===i?"var(--lighten_3)":i!==null&&l<i?"var(--lighten_2)":"transparent",_=u(()=>{var n,l;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((n=e.level.trial)==null?void 0:n.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((l=e.level.trial)==null?void 0:l.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=de(),k=J(d);{var q=n=>{var l=zt();let i;var o=v(l);xe(o,17,()=>({length:e.level.trial.sequence.length}),be,(h,B,W)=>{var R=qt();let U;T(I=>U=G(R,"",U,{"background-color":I}),[()=>m(e.level.status,W,a(s))]),c(h,R)});var w=f(o,2);O(w,"aria-valuemin",0),O(w,"aria-valuemax",100),r(l),T(h=>{i=G(l,"",i,{"--progress_bar_percent":a(_)}),O(w,"aria-valuenow",h)},[()=>Math.floor(a(_)*100)]),le(3,l,()=>ot),c(n,l)};L(k,n=>{e.level.trial&&n(q)})}c(x,d),ie()}var Bt=b('<div class="burst-item svelte-zx8aeo"> </div>'),Mt=b('<div class="burst svelte-zx8aeo"></div>');function We(x,e){se(e,!0);const s=z(e,"duration",3,2e3),m=z(e,"x_radius",3,250),_=z(e,"y_radius",3,250),d=z(e,"scale_min",3,1),k=z(e,"scale_max",3,dt),q=z(e,"hue_rotation_min",3,0),n=z(e,"hue_rotation_max",3,0),l=z(e,"start_rotation_min",3,0),i=z(e,"start_rotation_max",3,359),o=z(e,"end_rotation_min",3,0),w=z(e,"end_rotation_max",3,359);let h=P(!1),B;Ee(()=>(B=setTimeout(()=>N(h,!0),s()),()=>clearTimeout(B)));var W=de(),R=J(W);{var U=I=>{var A=Mt();let V;xe(A,21,()=>({length:e.count}),be,(re,he)=>{var C=Bt();let D;var ce=v(C,!0);r(C),T((ne,ve,K,_e,X,ue,Y)=>{D=G(C,"",D,{"--target_x":`${ne??""}px`,"--target_y":`${ve??""}px`,"--scale":K,"--start_rotation":`${_e??""}deg`,"--end_rotation":`${X??""}deg`,"--hue_rotation":`${ue??""}deg`}),fe(ce,Y)},[()=>ae(-m(),m()),()=>ae(-_(),_()),()=>ct(d(),k()),()=>ae(l(),i()),()=>ae(o(),w()),()=>ae(q(),n()),()=>ut(e.items)]),c(re,C)}),r(A),T(()=>V=G(A,"",V,{"--animation_timer":`${s()??""}ms`})),c(I,A)};L(R,I=>{a(h)||I(U)})}c(x,W),ie()}const St=(x,e,s)=>{x.target===a(e)&&s.level.retry_trial()};var Lt=b('<div class="size_xl3 text_align_center">flawless run!</div>'),Tt=b('<div class="size_xl3"> </div> <div> </div>',1),Kt=(x,e)=>e.exit_level(),Nt=(x,e)=>e.level.reset(),Pt=b('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),Gt=b('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),Wt=b('<!> <div aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div><!> <!></div></div>',1);function At(x,e){se(e,!0);const s=Fe.get(),m=mt.get();let _=P(void 0);const d=u(()=>e.level.level_data),k=u(()=>{var t;return(t=e.level.trial)==null?void 0:t.guessing_index}),q=u(()=>e.level.status==="presenting_prompt"?null:s.playing_notes),n=u(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Ee(()=>{e.level.start()});const l=t=>{console.log("press note key",t),e.level.guess(t)};let i=P(0),o=P(null);const w=u(()=>e.level.status==="waiting_for_input"),h=u(()=>e.level.status==="showing_success_feedback"),B=u(()=>e.level.status==="showing_failure_feedback"),W=u(()=>e.level.status==="complete");ze(()=>{a(h)&&Ie(R)}),ze(()=>{a(B)&&Ie(U)});const R=()=>{Be(i),N(o,"success"),re()},U=()=>{Be(i),N(o,"failure"),re()};let I=P(void 0),A=P(0),V=P(0);const re=()=>{if(!a(I))return;const t=e.level.last_guess;if(t===null)return;const g=a(I).querySelector(`[data-note="${t}"]`);if(!g)return;const y=g.getBoundingClientRect();N(A,y.x,!0),N(V,y.y+y.height/2)},he=u(()=>a(w)&&a(k)===0),C=20;let D=P(void 0);const ce=t=>{if(!(gt(t.target)||t.ctrlKey||t.shiftKey||t.altKey||t.metaKey))switch(t.key){case"r":{H(t),e.level.reset();return}case" ":switch(e.level.status){case"complete":{H(t),e.exit_level();return}default:{H(t),e.level.retry_trial();return}}case"d":{H(t),e.level.guess_correctly();return}case"a":{H(t),e.level.guess_incorrectly();return}case"w":{H(t),e.level.win();return}}};var ne=Wt();Ye("keydown",rt,ce,!0);var ve=J(ne);ft(ve,{get midi_access(){return s.midi_access},onnotestart:(t,g)=>{e.level.status==="complete"?Le(s,m(),t,Te(s.volume,g),s.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(t))},onnotestop:t=>{Se(t)}});var K=f(ve,2);let _e;K.__click=[St,D,e];var X=v(K),ue=v(X);jt(ue,{get level(){return e.level}}),r(X);var Y=f(X,2),Re=v(Y);It(Re,{get level(){return e.level}}),r(Y);var p=f(Y,2);G(p,"",{},{padding:"20px"});var Ue=v(p);{var Ce=t=>{const g=u(()=>a(_)-C*2),y=u(()=>{var j;return(j=e.level.trial)==null?void 0:j.valid_notes}),M=u(()=>e.level.status==="waiting_for_input"?j=>l(j):e.level.status==="complete"?j=>Le(s,m(),j,Te(s.volume,null),s.instrument):void 0),E=u(()=>e.level.status==="complete"?j=>Se(j):void 0);bt(t,{get width(){return a(g)},get min_note(){return a(d).min_note},get max_note(){return a(d).max_note},get enabled_notes(){return a(y)},get pressed_keys(){return a(q)},get highlighted_keys(){return a(n)},get onpress(){return a(M)},get onrelease(){return a(E)}})};L(Ue,t=>{a(_)&&t(Ce)})}r(p),Pe(p,t=>N(I,t),()=>a(I));var me=f(p,2);let ye;var ke=v(me);{var De=t=>{var g=Pt(),y=v(g),M=v(y),E=v(M),j=f(E,2);r(M);var $=f(M,2),ee=v($),S=v(ee);{var F=Z=>{var oe=Lt();c(Z,oe)},te=Z=>{var oe=Tt(),ge=J(oe),Oe=v(ge,!0);r(ge);var je=f(ge,2),Ve=v(je);r(je),T(Xe=>{fe(Oe,e.level.mistakes),fe(Ve,`mistake${Xe??""} this run`)},[()=>_t(e.level.mistakes)]),c(Z,oe)};L(S,Z=>{e.level.mistakes===0?Z(F):Z(te,!1)})}r(ee);var Q=f(ee,2),He=v(Q);yt(He,{get level_data(){return a(d)},get level_stats(){return e.level_stats}}),r(Q),r($);var we=f($,2);we.__click=[Kt,e];var Je=f(we,2);Je.__click=[Nt,e],r(y),r(g),le(1,E,()=>Ke,()=>({duration:4e3,x:-200})),le(1,j,()=>Ke,()=>({duration:4e3,x:200})),le(1,M,()=>Ne,()=>({duration:3e3})),le(3,y,()=>Ne),c(t,g)};L(ke,t=>{a(W)&&t(De)})}var Qe=f(ke,2);{var Ze=t=>{var g=Gt(),y=v(g);let M;var E=v(y);{var j=S=>{var F=de(),te=J(F);Ge(te,()=>a(i),Q=>{We(Q,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),c(S,F)};L(E,S=>{a(o)==="success"&&S(j)})}var $=f(E,2);{var ee=S=>{var F=de(),te=J(F);Ge(te,()=>a(i),Q=>{We(Q,{count:5,items:["🦜","⁉","❔","❌"]})}),c(S,F)};L($,S=>{a(o)==="failure"&&S(ee)})}r(y),r(g),T(()=>M=G(y,"",M,{transform:`translate3d(${a(A)??""}px, ${a(V)??""}px, 0)`})),c(t,g)};L(Qe,t=>{a(o)!==null&&t(Ze)})}r(me),r(K),Pe(K,t=>N(D,t),()=>a(D)),T((t,g)=>{_e=Me(K,1,"level svelte-16m1rsw",null,_e,t),ye=Me(me,1,"feedback svelte-16m1rsw",null,ye,g)},[()=>({initial:a(he)}),()=>({success:a(h),failure:a(B),complete:a(W)})]),xt(K,"clientWidth",t=>N(_,t)),c(x,ne),ie()}Ae(["click"]);var Et=b('<div class="level svelte-1jfpjrg"><!></div>'),Ft=b('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Rt=b('<main class="svelte-1jfpjrg"><!> <!></main>');function Vt(x,e){se(e,!0);const s=Fe.get(),m=u(()=>{var l;return(l=s.selected_project_data)==null?void 0:l.level_stats});var _=Rt();pe(l=>{nt.title="Earbetter trainer level"});var d=v(_);ht(d,{get onclick(){return s.exit_level}});var k=f(d,2);{var q=l=>{var i=Et(),o=v(i);At(o,{get level(){return s.level},get level_stats(){return a(m)},get exit_level(){return s.exit_level}}),r(i),c(l,i)},n=l=>{var i=Ft(),o=v(i),w=f(v(o));w.__click=function(...h){var B;(B=s.exit_level)==null||B.apply(this,h)},vt(),r(o),r(i),c(l,i)};L(k,l=>{s.level&&a(m)?l(q):l(n,!1)})}r(_),c(x,_),ie()}Ae(["click"]);export{Vt as component};
