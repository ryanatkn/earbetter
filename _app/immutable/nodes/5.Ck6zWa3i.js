import{h as ke,g as Qe,l as Ve,U as Ze,c as n,s as l,a as u,t as k,r as i,d as te,f as R,b as ce,v as Ke,u as Fe,$ as He,w as Je,x as Oe,n as Xe}from"../chunks/disclose-version.wE5PaFVB.js";import{w as Ye,V as pe,z as $e,y as et,p as J,t as b,a as O,g as t,d as m,Q as Pe,s as K,h as P,D as we,u as ye,W as je}from"../chunks/index-client.DEO7R3f7.js";import{i as M,p as I,a as tt}from"../chunks/props.BV_xrcCh.js";import{e as ue,s as U,i as me,b as y,t as ee}from"../chunks/style.BI6wc9N8.js";import{t as H,u as at,G as lt,v as F,x as st,y as rt,g as Ne,j as it,n as ze,w as qe,k as Ie,i as nt,s as G,A as Be,B as Se}from"../chunks/index.jXID5wF_.js";import{M as vt,b as _t,P as ot,B as dt}from"../chunks/Back_Button.BgZcs9P0.js";import{b as Le}from"../chunks/this.CUByJSBG.js";import{p as ct}from"../chunks/string.Dn_jmF-S.js";import{L as ut}from"../chunks/Level_Stats_Summary.VJbGRf9a.js";function Me(x,e,r){ke&&Qe();var g=x,_=Ze,d;Ye(()=>{pe(_,_=e())&&(d&&$e(d),d=et(()=>r(g)))}),ke&&(g=Ve)}var mt=k('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),gt=k('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function ft(x,e){J(e,!0);const r=(v,s,o,c)=>v==="complete"?"var(--lighten_5)":o[c]?s&&c===s.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",g=m(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var _=gt(),d=n(_);ue(d,17,()=>({length:e.level.level_data.trial_count}),me,(v,s,o)=>{var c=mt();b(()=>y(c,"background-color",r(e.level.status,e.level.trial,e.level.trials,o))),u(v,c)});var j=l(l(d,!0));U(j,"aria-valuemin",0),U(j,"aria-valuemax",100),i(_),b(()=>{y(_,"--progress_bar_percent",t(g)),U(j,"aria-valuenow",Math.floor(t(g)*100))}),u(x,_),O()}var bt=k('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),xt=k('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function ht(x,e){J(e,!0);const r=m(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),g=(v,s,o)=>v==="showing_failure_feedback"?"transparent":v==="complete"||v==="showing_success_feedback"?"var(--lighten_4)":s===o?"var(--lighten_3)":o!==null&&s<o?"var(--lighten_2)":"transparent",_=m(()=>{var v,s;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((v=e.level.trial)==null?void 0:v.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((s=e.level.trial)==null?void 0:s.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=te(),j=R(d);M(j,()=>e.level.trial,v=>{var s=xt(),o=n(s);ue(o,17,()=>({length:e.level.trial.sequence.length}),me,(z,N,W)=>{var T=bt();b(()=>y(T,"background-color",g(e.level.status,W,t(r)))),u(z,T)});var c=l(l(o,!0));U(c,"aria-valuemin",0),U(c,"aria-valuemax",100),i(s),b(()=>{y(s,"--progress_bar_percent",t(_)),U(c,"aria-valuenow",Math.floor(t(_)*100))}),H(3,s,()=>at),u(v,s)}),u(x,d),O()}var kt=k('<div class="burst-item svelte-zx8aeo"> </div>'),wt=k('<div class="burst svelte-zx8aeo"></div>');function Te(x,e){J(e,!0);const r=I(e,"duration",3,2e3),g=I(e,"x_radius",3,250),_=I(e,"y_radius",3,250),d=I(e,"scale_min",3,1),j=I(e,"scale_max",3,lt),v=I(e,"hue_rotation_min",3,0),s=I(e,"hue_rotation_max",3,0),o=I(e,"start_rotation_min",3,0),c=I(e,"start_rotation_max",3,359),z=I(e,"end_rotation_min",3,0),N=I(e,"end_rotation_max",3,359);let W=P(!1),T;Pe(()=>(T=setTimeout(()=>K(W,!0),r()),()=>clearTimeout(T)));var C=te(),ae=R(C);M(ae,()=>!t(W),le=>{var B=wt();ue(B,21,()=>({length:e.count}),me,(X,se,re)=>{var q=kt();b(()=>y(q,"--target_x",`${F(-g(),g())??""}px`)),b(()=>y(q,"--target_y",`${F(-_(),_())??""}px`)),b(()=>y(q,"--scale",st(d(),j()))),b(()=>y(q,"--start_rotation",`${F(o(),c())??""}deg`)),b(()=>y(q,"--end_rotation",`${F(z(),N())??""}deg`)),b(()=>y(q,"--hue_rotation",`${F(v(),s())??""}deg`));var Y=n(q);b(()=>ce(Y,rt(e.items))),i(q),u(X,q)}),i(B),b(()=>y(B,"--animation_timer",`${r()??""}ms`)),u(le,B)}),u(x,C),O()}const yt=(x,e,r)=>{x.target===t(e)&&r.level.retry_trial()};var jt=k('<div class="size_xl3 text_align_center">flawless run!</div>'),zt=k('<div class="size_xl3"> </div> <div> </div>',1),qt=(x,e)=>e.exit_level(),It=(x,e)=>e.level.reset(),Bt=k('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),St=k('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),Lt=k('<!> <div class="level svelte-16m1rsw" aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div class="feedback svelte-16m1rsw"><!> <!></div></div>',1);function Mt(x,e){J(e,!0);const r=Ne(),g=it();let _=P(void 0);const d=m(()=>e.level.level_data),j=m(()=>{var a;return(a=e.level.trial)==null?void 0:a.guessing_index}),v=m(()=>e.level.status==="presenting_prompt"?null:r.playing_notes),s=m(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Pe(()=>{e.level.start()});const o=a=>{console.log("press note key",a),e.level.guess(a)};let c=P(0),z=P(null);const N=m(()=>e.level.status==="waiting_for_input"),W=m(()=>e.level.status==="showing_success_feedback"),T=m(()=>e.level.status==="showing_failure_feedback"),C=m(()=>e.level.status==="complete");we(()=>{t(W)&&ye(ae)}),we(()=>{t(T)&&ye(le)});const ae=()=>{je(c),K(z,"success"),re()},le=()=>{je(c),K(z,"failure"),re()};let B=P(void 0),X=P(0),se=P(0);const re=()=>{if(!t(B))return;const a=e.level.last_guess;if(a===null)return;const h=t(B).querySelector(`[data-note="${a}"]`);if(!h)return;const w=h.getBoundingClientRect();K(X,tt(w.x)),K(se,w.y+w.height/2)},q=m(()=>t(N)&&t(j)===0),Y=20;let ie=P(void 0);const We=a=>{if(!(nt(a.target)||a.ctrlKey||a.shiftKey||a.altKey||a.metaKey))switch(a.key){case"r":{G(a),e.level.reset();return}case" ":switch(e.level.status){case"complete":{G(a),e.exit_level();return}default:{G(a),e.level.retry_trial();return}}case"d":{G(a),e.level.guess_correctly();return}case"a":{G(a),e.level.guess_incorrectly();return}case"w":{G(a),e.level.win();return}}};var ge=Lt();Fe("keydown",He,We,!0);var fe=R(ge);vt(fe,{get midi_access(){return r.midi_access},onnotestart:(a,h)=>{e.level.status==="complete"?ze(r,g(),a,qe(r.volume,h),r.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(a))},onnotestop:a=>{Ie(a)}});var D=l(l(fe,!0));Le(D,a=>K(ie,a),()=>t(ie)),D.__click=[yt,ie,e];var ne=n(D),Ae=n(ne);ft(Ae,{get level(){return e.level}}),i(ne);var ve=l(l(ne,!0)),De=n(ve);ht(De,{get level(){return e.level}}),i(ve);var Q=l(l(ve,!0));Le(Q,a=>K(B,a),()=>t(B)),y(Q,"padding",`${Y}px`);var Ee=n(Q);M(Ee,()=>t(_),a=>{var h=m(()=>t(_)-Y*2),w=m(()=>{var f;return(f=e.level.trial)==null?void 0:f.valid_notes}),S=m(()=>e.level.status==="waiting_for_input"?f=>o(f):e.level.status==="complete"?f=>ze(r,g(),f,qe(r.volume,null),r.instrument):void 0),E=m(()=>e.level.status==="complete"?f=>Ie(f):void 0);ot(a,{get width(){return t(h)},get min_note(){return t(d).min_note},get max_note(){return t(d).max_note},get enabled_notes(){return t(w)},get pressed_keys(){return t(v)},get highlighted_keys(){return t(s)},get onpress(){return t(S)},get onrelease(){return t(E)}})}),i(Q);var V=l(l(Q,!0)),be=n(V);M(be,()=>t(C),a=>{var h=Bt(),w=n(h),S=n(w),E=n(S),f=l(l(E,!0));l(n(f)),i(f),i(S);var L=l(l(S,!0)),A=n(L),Z=n(A);M(Z,()=>e.level.mistakes===0,oe=>{var $=jt();u(oe,$)},oe=>{var $=zt(),de=R($),Ue=n(de);i(de);var he=l(l(de,!0)),Ce=n(he);b(()=>ce(Ce,`mistake${ct(e.level.mistakes)??""} this run`)),i(he),b(()=>ce(Ue,e.level.mistakes)),u(oe,$)}),i(A);var xe=l(l(A,!0)),Re=n(xe);ut(Re,{get level_data(){return t(d)},get level_stats(){return e.level_stats}}),i(xe),i(L);var p=l(l(L,!0));p.__click=[qt,e],l(n(p)),i(p);var _e=l(l(p,!0));_e.__click=[It,e],l(n(_e)),i(_e),i(w),i(h),H(3,w,()=>Be),H(1,S,()=>Be,()=>({duration:3e3})),H(1,E,()=>Se,()=>({duration:4e3,x:-200})),H(1,f,()=>Se,()=>({duration:4e3,x:200})),u(a,h)});var Ge=l(l(be,!0));M(Ge,()=>t(z)!==null,a=>{var h=St(),w=n(h),S=n(w);M(S,()=>t(z)==="success",f=>{var L=te(),A=R(L);Me(A,()=>t(c),Z=>{Te(Z,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),u(f,L)});var E=l(l(S,!0));M(E,()=>t(z)==="failure",f=>{var L=te(),A=R(L);Me(A,()=>t(c),Z=>{Te(Z,{count:5,items:["🦜","⁉","❔","❌"]})}),u(f,L)}),i(w),i(h),b(()=>y(w,"transform",`translate3d(${t(X)??""}px, ${t(se)??""}px, 0)`)),u(a,h)}),i(V),i(D),b(()=>{ee(D,"initial",t(q)),ee(V,"success",t(W)),ee(V,"failure",t(T)),ee(V,"complete",t(C))}),_t(D,"clientWidth",a=>K(_,a)),u(x,ge),O()}Ke(["click"]);var Tt=k('<div class="level svelte-1jfpjrg"><!></div>'),Kt=k('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Pt=k('<main class="svelte-1jfpjrg"><!> <!></main>');function Qt(x,e){J(e,!0);const r=Ne(),g=m(()=>{var v;return(v=r.selected_project_data)==null?void 0:v.level_stats});var _=Pt();Je(v=>{Oe.title="Earbetter trainer level"});var d=n(_);dt(d,{get onclick(){return r.exit_level}});var j=l(l(d,!0));M(j,()=>r.level&&t(g),v=>{var s=Tt(),o=n(s);Mt(o,{get level(){return r.level},get level_stats(){return t(g)},get exit_level(){return r.exit_level}}),i(s),u(v,s)},v=>{var s=Kt(),o=n(s),c=l(n(o));c.__click=function(...z){var N;(N=r.exit_level)==null||N.apply(this,z)},Xe(),i(o),i(s),u(v,s)}),i(_),u(x,_),O()}Ke(["click"]);export{Qt as component};
