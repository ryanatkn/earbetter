import{a as g,t as h,d as _e,b as me,h as Ae,g as Oe,i as Qe}from"../chunks/disclose-version.DbIX9lBU.js";import{z as we,A as Ve,y as Xe,I as pe,G as $e,J as et,U as tt,av as at,a as te,c as v,t as u,s as f,r as n,p as ae,g as t,d as r,f as J,a4 as Ge,k as G,_ as N,Y as je,u as ze,aw as qe,$ as lt,a0 as st,n as it}from"../chunks/index-client.BoISVktJ.js";import{i as M,p as B,a as rt}from"../chunks/props.Dc3VY8m1.js";import{e as fe,i as be,s as Y,b as w,t as ve,p as nt}from"../chunks/string.CP9_p8aN.js";import{t as ee,u as vt,G as _t,v as ot,x as $,y as dt,f as Ne,j as ct,o as Ie,w as Be,k as Se,i as ut,s as D,A as Le,B as Me}from"../chunks/index.wDcSWpFq.js";import{M as gt,b as mt,P as ft,B as bt}from"../chunks/Back_Button.BQXQClOF.js";import{b as Te}from"../chunks/this.Clzg12Qd.js";import{L as xt}from"../chunks/Level_Stats_Summary.DZ7D4E0l.js";function Ke(b,e,i){we&&Ve();var m=b,_=tt,d,y=at;Xe(()=>{y(_,_=e())&&(d&&pe(d),d=$e(()=>i(m)))}),we&&(m=et)}var ht=h('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),yt=h('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function kt(b,e){te(e,!0);const i=(z,o,l,s)=>z==="complete"?"var(--lighten_5)":l[s]?o&&s===o.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",m=r(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var _=yt(),d=v(_);fe(d,17,()=>({length:e.level.level_data.trial_count}),be,(z,o,l)=>{var s=ht();const c=r(()=>i(e.level.status,e.level.trial,e.level.trials,l));u(()=>w(s,"background-color",t(c))),g(z,s)});var y=f(d,2);Y(y,"aria-valuemin",0),Y(y,"aria-valuemax",100),u(()=>Y(y,"aria-valuenow",Math.floor(t(m)*100))),n(_),u(()=>w(_,"--progress_bar_percent",t(m))),g(b,_),ae()}var wt=h('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),jt=h('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function zt(b,e){te(e,!0);const i=r(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),m=(o,l,s)=>o==="showing_failure_feedback"?"transparent":o==="complete"||o==="showing_success_feedback"?"var(--lighten_4)":l===s?"var(--lighten_3)":s!==null&&l<s?"var(--lighten_2)":"transparent",_=r(()=>{var o,l;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((o=e.level.trial)==null?void 0:o.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((l=e.level.trial)==null?void 0:l.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=_e(),y=J(d);{var z=o=>{var l=jt(),s=v(l);fe(s,17,()=>({length:e.level.trial.sequence.length}),be,(E,T,S)=>{var K=wt();const Z=r(()=>m(e.level.status,S,t(i)));u(()=>w(K,"background-color",t(Z))),g(E,K)});var c=f(s,2);Y(c,"aria-valuemin",0),Y(c,"aria-valuemax",100),u(()=>Y(c,"aria-valuenow",Math.floor(t(_)*100))),n(l),u(()=>w(l,"--progress_bar_percent",t(_))),ee(3,l,()=>vt),g(o,l)};M(y,o=>{e.level.trial&&o(z)})}g(b,d),ae()}var qt=h('<div class="burst-item svelte-zx8aeo"> </div>'),It=h('<div class="burst svelte-zx8aeo"></div>');function Pe(b,e){te(e,!0);const i=B(e,"duration",3,2e3),m=B(e,"x_radius",3,250),_=B(e,"y_radius",3,250),d=B(e,"scale_min",3,1),y=B(e,"scale_max",3,_t),z=B(e,"hue_rotation_min",3,0),o=B(e,"hue_rotation_max",3,0),l=B(e,"start_rotation_min",3,0),s=B(e,"start_rotation_max",3,359),c=B(e,"end_rotation_min",3,0),E=B(e,"end_rotation_max",3,359);let T=N(!1),S;Ge(()=>(S=setTimeout(()=>G(T,!0),i()),()=>clearTimeout(S)));var K=_e(),Z=J(K);{var oe=P=>{var R=It();fe(R,21,()=>({length:e.count}),be,(le,de)=>{var q=qt();const se=r(()=>`${$(-m(),m())??""}px`);u(()=>w(q,"--target_x",t(se)));const F=r(()=>`${$(-_(),_())??""}px`);u(()=>w(q,"--target_y",t(F)));const ce=r(()=>dt(d(),y()));u(()=>w(q,"--scale",t(ce)));const ie=r(()=>`${$(l(),s())??""}deg`);u(()=>w(q,"--start_rotation",t(ie)));const re=r(()=>`${$(c(),E())??""}deg`);u(()=>w(q,"--end_rotation",t(re)));const A=r(()=>`${$(z(),o())??""}deg`);u(()=>w(q,"--hue_rotation",t(A)));var H=v(q,!0);u(()=>me(H,ot(e.items))),n(q),g(le,q)}),n(R),u(()=>w(R,"--animation_timer",`${i()??""}ms`)),g(P,R)};M(Z,P=>{t(T)||P(oe)})}g(b,K),ae()}const Bt=(b,e,i)=>{b.target===t(e)&&i.level.retry_trial()};var St=h('<div class="size_xl3 text_align_center">flawless run!</div>'),Lt=h('<div class="size_xl3"> </div> <div> </div>',1),Mt=(b,e)=>e.exit_level(),Tt=(b,e)=>e.level.reset(),Kt=h('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),Pt=h('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),At=h('<!> <div class="level svelte-16m1rsw" aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div class="feedback svelte-16m1rsw"><!> <!></div></div>',1);function Gt(b,e){te(e,!0);const i=Ne.get(),m=ct.get();let _=N(void 0);const d=r(()=>e.level.level_data),y=r(()=>{var a;return(a=e.level.trial)==null?void 0:a.guessing_index}),z=r(()=>e.level.status==="presenting_prompt"?null:i.playing_notes),o=r(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Ge(()=>{e.level.start()});const l=a=>{console.log("press note key",a),e.level.guess(a)};let s=N(0),c=N(null);const E=r(()=>e.level.status==="waiting_for_input"),T=r(()=>e.level.status==="showing_success_feedback"),S=r(()=>e.level.status==="showing_failure_feedback"),K=r(()=>e.level.status==="complete");je(()=>{t(T)&&ze(Z)}),je(()=>{t(S)&&ze(oe)});const Z=()=>{qe(s),G(c,"success"),de()},oe=()=>{qe(s),G(c,"failure"),de()};let P=N(void 0),R=N(0),le=N(0);const de=()=>{if(!t(P))return;const a=e.level.last_guess;if(a===null)return;const x=t(P).querySelector(`[data-note="${a}"]`);if(!x)return;const k=x.getBoundingClientRect();G(R,rt(k.x)),G(le,k.y+k.height/2)},q=r(()=>t(E)&&t(y)===0),se=20;let F=N(void 0);const ce=a=>{if(!(ut(a.target)||a.ctrlKey||a.shiftKey||a.altKey||a.metaKey))switch(a.key){case"r":{D(a),e.level.reset();return}case" ":switch(e.level.status){case"complete":{D(a),e.exit_level();return}default:{D(a),e.level.retry_trial();return}}case"d":{D(a),e.level.guess_correctly();return}case"a":{D(a),e.level.guess_incorrectly();return}case"w":{D(a),e.level.win();return}}};var ie=At();Oe("keydown",lt,ce,!0);var re=J(ie);gt(re,{get midi_access(){return i.midi_access},onnotestart:(a,x)=>{e.level.status==="complete"?Ie(i,m(),a,Be(i.volume,x),i.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(a))},onnotestop:a=>{Se(a)}});var A=f(re,2);A.__click=[Bt,F,e];var H=v(A),Ee=v(H);kt(Ee,{get level(){return e.level}}),n(H);var ue=f(H,2),Re=v(ue);zt(Re,{get level(){return e.level}}),n(ue);var O=f(ue,2);w(O,"padding",`${se}px`);var Ue=v(O);{var We=a=>{var x=r(()=>t(_)-se*2),k=r(()=>{var j;return(j=e.level.trial)==null?void 0:j.valid_notes}),L=r(()=>e.level.status==="waiting_for_input"?j=>l(j):e.level.status==="complete"?j=>Ie(i,m(),j,Be(i.volume,null),i.instrument):void 0),W=r(()=>e.level.status==="complete"?j=>Se(j):void 0);ft(a,{get width(){return t(x)},get min_note(){return t(d).min_note},get max_note(){return t(d).max_note},get enabled_notes(){return t(k)},get pressed_keys(){return t(z)},get highlighted_keys(){return t(o)},get onpress(){return t(L)},get onrelease(){return t(W)}})};M(Ue,a=>{t(_)&&a(We)})}n(O),Te(O,a=>G(P,a),()=>t(P));var Q=f(O,2),xe=v(Q);{var Ce=a=>{var x=Kt(),k=v(x),L=v(k),W=v(L),j=f(W,2);n(L);var V=f(L,2),I=v(V),U=v(I);{var X=C=>{var ne=St();g(C,ne)},p=C=>{var ne=Lt(),ge=J(ne),Fe=v(ge,!0);n(ge);var ke=f(ge,2),He=v(ke);u(()=>me(He,`mistake${nt(e.level.mistakes)??""} this run`)),n(ke),u(()=>me(Fe,e.level.mistakes)),g(C,ne)};M(U,C=>{e.level.mistakes===0?C(X):C(p,!1)})}n(I);var he=f(I,2),Ye=v(he);xt(Ye,{get level_data(){return t(d)},get level_stats(){return e.level_stats}}),n(he),n(V);var ye=f(V,2);ye.__click=[Mt,e];var Ze=f(ye,2);Ze.__click=[Tt,e],n(k),n(x),ee(1,W,()=>Le,()=>({duration:4e3,x:-200})),ee(1,j,()=>Le,()=>({duration:4e3,x:200})),ee(1,L,()=>Me,()=>({duration:3e3})),ee(3,k,()=>Me),g(a,x)};M(xe,a=>{t(K)&&a(Ce)})}var De=f(xe,2);{var Je=a=>{var x=Pt(),k=v(x),L=v(k);{var W=I=>{var U=_e(),X=J(U);Ke(X,()=>t(s),p=>{Pe(p,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),g(I,U)};M(L,I=>{t(c)==="success"&&I(W)})}var j=f(L,2);{var V=I=>{var U=_e(),X=J(U);Ke(X,()=>t(s),p=>{Pe(p,{count:5,items:["🦜","⁉","❔","❌"]})}),g(I,U)};M(j,I=>{t(c)==="failure"&&I(V)})}n(k),n(x),u(()=>w(k,"transform",`translate3d(${t(R)??""}px, ${t(le)??""}px, 0)`)),g(a,x)};M(De,a=>{t(c)!==null&&a(Je)})}n(Q),n(A),Te(A,a=>G(F,a),()=>t(F)),u(()=>{ve(A,"initial",t(q)),ve(Q,"success",t(T)),ve(Q,"failure",t(S)),ve(Q,"complete",t(K))}),mt(A,"clientWidth",a=>G(_,a)),g(b,ie),ae()}Ae(["click"]);var Nt=h('<div class="level svelte-1jfpjrg"><!></div>'),Et=h('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Rt=h('<main class="svelte-1jfpjrg"><!> <!></main>');function Ht(b,e){te(e,!0);const i=Ne.get(),m=r(()=>{var l;return(l=i.selected_project_data)==null?void 0:l.level_stats});var _=Rt();Qe(l=>{st.title="Earbetter trainer level"});var d=v(_);bt(d,{get onclick(){return i.exit_level}});var y=f(d,2);{var z=l=>{var s=Nt(),c=v(s);Gt(c,{get level(){return i.level},get level_stats(){return t(m)},get exit_level(){return i.exit_level}}),n(s),g(l,s)},o=l=>{var s=Et(),c=v(s),E=f(v(c));E.__click=function(...T){var S;(S=i.exit_level)==null||S.apply(this,T)},it(),n(c),n(s),g(l,s)};M(y,l=>{i.level&&t(m)?l(z):l(o,!1)})}n(_),g(b,_),ae()}Ae(["click"]);export{Ht as component};
