import{a as m,t as y,d as ae,b as ce,h as Me,g as Je,i as Re}from"../chunks/disclose-version.BKNlT-YU.js";import{C as xe,D as Ue,y as We,aI as Ze,B as Fe,A as He,J as Oe,U as Qe,p as Q,t as u,a as V,c as _,s as h,r as n,g as t,d as i,f as R,a7 as Te,k as T,a1 as K,$ as ye,a2 as Ve,u as ke,aJ as we,a3 as Xe,n as Ye}from"../chunks/index-client.BoyXeee0.js";import{i as S,p as I,a as pe}from"../chunks/props.D3HXCBXF.js";import{e as me,s as U,i as ge,c as j,p as $e,t as te}from"../chunks/string.CDuhMoWR.js";import{t as ue,u as et,G as tt,v as at,x as O,y as lt,f as Ke,j as st,n as je,w as qe,k as ze,i as it,s as J,A as Ie}from"../chunks/index.B-bFX673.js";import{M as rt,b as nt,P as vt,B as _t}from"../chunks/Back_Button.DWbUEm7J.js";import{b as Be}from"../chunks/this.DQxifKK9.js";import{L as ot}from"../chunks/Level_Stats_Summary.Dp1jphF-.js";function Se(b,e,s){xe&&Ue();var g=b,v=Qe,d;We(()=>{Ze(v,v=e())&&(d&&Fe(d),d=He(()=>s(g)))}),xe&&(g=Oe)}var dt=y('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),ct=y('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function ut(b,e){Q(e,!0);const s=(r,l,o,c)=>r==="complete"?"var(--lighten_5)":o[c]?l&&c===l.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",g=i(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var v=ct(),d=_(v);me(d,17,()=>({length:e.level.level_data.trial_count}),ge,(r,l,o)=>{var c=dt();const k=i(()=>s(e.level.status,e.level.trial,e.level.trials,o));u(()=>j(c,"background-color",t(k))),m(r,c)});var z=h(d,2);U(z,"aria-valuemin",0),U(z,"aria-valuemax",100),u(()=>U(z,"aria-valuenow",Math.floor(t(g)*100))),n(v),u(()=>j(v,"--progress_bar_percent",t(g))),m(b,v),V()}var mt=y('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),gt=y('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function ft(b,e){Q(e,!0);const s=i(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),g=(r,l,o)=>r==="showing_failure_feedback"?"transparent":r==="complete"||r==="showing_success_feedback"?"var(--lighten_4)":l===o?"var(--lighten_3)":o!==null&&l<o?"var(--lighten_2)":"transparent",v=i(()=>{var r,l;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((r=e.level.trial)==null?void 0:r.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((l=e.level.trial)==null?void 0:l.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=ae(),z=R(d);S(z,()=>e.level.trial,r=>{var l=gt(),o=_(l);me(o,17,()=>({length:e.level.trial.sequence.length}),ge,(k,P,A)=>{var L=mt();const N=i(()=>g(e.level.status,A,t(s)));u(()=>j(L,"background-color",t(N))),m(k,L)});var c=h(o,2);U(c,"aria-valuemin",0),U(c,"aria-valuemax",100),u(()=>U(c,"aria-valuenow",Math.floor(t(v)*100))),n(l),u(()=>j(l,"--progress_bar_percent",t(v))),ue(3,l,()=>et),m(r,l)}),m(b,d),V()}var bt=y('<div class="burst-item svelte-zx8aeo"> </div>'),ht=y('<div class="burst svelte-zx8aeo"></div>');function Le(b,e){Q(e,!0);const s=I(e,"duration",3,2e3),g=I(e,"x_radius",3,250),v=I(e,"y_radius",3,250),d=I(e,"scale_min",3,1),z=I(e,"scale_max",3,tt),r=I(e,"hue_rotation_min",3,0),l=I(e,"hue_rotation_max",3,0),o=I(e,"start_rotation_min",3,0),c=I(e,"start_rotation_max",3,359),k=I(e,"end_rotation_min",3,0),P=I(e,"end_rotation_max",3,359);let A=K(!1),L;Te(()=>(L=setTimeout(()=>T(A,!0),s()),()=>clearTimeout(L)));var N=ae(),le=R(N);S(le,()=>!t(A),se=>{var B=ht();me(B,21,()=>({length:e.count}),ge,(X,ie)=>{var q=bt();const re=i(()=>`${O(-g(),g())??""}px`);u(()=>j(q,"--target_x",t(re)));const Y=i(()=>`${O(-v(),v())??""}px`);u(()=>j(q,"--target_y",t(Y)));const W=i(()=>lt(d(),z()));u(()=>j(q,"--scale",t(W)));const ne=i(()=>`${O(o(),c())??""}deg`);u(()=>j(q,"--start_rotation",t(ne)));const p=i(()=>`${O(k(),P())??""}deg`);u(()=>j(q,"--end_rotation",t(p)));const $=i(()=>`${O(r(),l())??""}deg`);u(()=>j(q,"--hue_rotation",t($)));var M=_(q,!0);u(()=>ce(M,at(e.items))),n(q),m(X,q)}),n(B),u(()=>j(B,"--animation_timer",`${s()??""}ms`)),m(se,B)}),m(b,N),V()}const xt=(b,e,s)=>{b.target===t(e)&&s.level.retry_trial()};var yt=y('<div class="size_xl3 text_align_center">flawless run!</div>'),kt=y('<div class="size_xl3"> </div> <div> </div>',1),wt=(b,e)=>e.exit_level(),jt=(b,e)=>e.level.reset(),qt=y('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),zt=y('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),It=y('<!> <div class="level svelte-16m1rsw" aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div class="feedback svelte-16m1rsw"><!> <!></div></div>',1);function Bt(b,e){Q(e,!0);const s=Ke.get(),g=st.get();let v=K(void 0);const d=i(()=>e.level.level_data),z=i(()=>{var a;return(a=e.level.trial)==null?void 0:a.guessing_index}),r=i(()=>e.level.status==="presenting_prompt"?null:s.playing_notes),l=i(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Te(()=>{e.level.start()});const o=a=>{console.log("press note key",a),e.level.guess(a)};let c=K(0),k=K(null);const P=i(()=>e.level.status==="waiting_for_input"),A=i(()=>e.level.status==="showing_success_feedback"),L=i(()=>e.level.status==="showing_failure_feedback"),N=i(()=>e.level.status==="complete");ye(()=>{t(A)&&ke(le)}),ye(()=>{t(L)&&ke(se)});const le=()=>{we(c),T(k,"success"),q()},se=()=>{we(c),T(k,"failure"),q()};let B=K(void 0),X=K(0),ie=K(0);const q=()=>{if(!t(B))return;const a=e.level.last_guess;if(a===null)return;const x=t(B).querySelector(`[data-note="${a}"]`);if(!x)return;const w=x.getBoundingClientRect();T(X,pe(w.x)),T(ie,w.y+w.height/2)},re=i(()=>t(P)&&t(z)===0),Y=20;let W=K(void 0);const ne=a=>{if(!(it(a.target)||a.ctrlKey||a.shiftKey||a.altKey||a.metaKey))switch(a.key){case"r":{J(a),e.level.reset();return}case" ":switch(e.level.status){case"complete":{J(a),e.exit_level();return}default:{J(a),e.level.retry_trial();return}}case"d":{J(a),e.level.guess_correctly();return}case"a":{J(a),e.level.guess_incorrectly();return}case"w":{J(a),e.level.win();return}}};var p=It();Je("keydown",Ve,ne,!0);var $=R(p);rt($,{get midi_access(){return s.midi_access},onnotestart:(a,x)=>{e.level.status==="complete"?je(s,g(),a,qe(s.volume,x),s.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(a))},onnotestop:a=>{ze(a)}});var M=h($,2);Be(M,a=>T(W,a),()=>t(W)),M.__click=[xt,W,e];var ve=_(M),Pe=_(ve);ut(Pe,{get level(){return e.level}}),n(ve);var _e=h(ve,2),Ae=_(_e);ft(Ae,{get level(){return e.level}}),n(_e);var Z=h(_e,2);Be(Z,a=>T(B,a),()=>t(B)),j(Z,"padding",`${Y}px`);var Ne=_(Z);S(Ne,()=>t(v),a=>{var x=i(()=>t(v)-Y*2),w=i(()=>{var f;return(f=e.level.trial)==null?void 0:f.valid_notes}),C=i(()=>e.level.status==="waiting_for_input"?f=>o(f):e.level.status==="complete"?f=>je(s,g(),f,qe(s.volume,null),s.instrument):void 0),D=i(()=>e.level.status==="complete"?f=>ze(f):void 0);vt(a,{get width(){return t(x)},get min_note(){return t(d).min_note},get max_note(){return t(d).max_note},get enabled_notes(){return t(w)},get pressed_keys(){return t(r)},get highlighted_keys(){return t(l)},get onpress(){return t(C)},get onrelease(){return t(D)}})}),n(Z);var F=h(Z,2),fe=_(F);S(fe,()=>t(N),a=>{var x=qt(),w=_(x),C=_(w),D=h(C,2),f=_(D),E=_(f);S(E,()=>e.level.mistakes===0,oe=>{var ee=yt();m(oe,ee)},oe=>{var ee=kt(),de=R(ee),Ee=_(de,!0);n(de);var he=h(de,2),Ge=_(he);u(()=>ce(Ge,`mistake${$e(e.level.mistakes)??""} this run`)),n(he),u(()=>ce(Ee,e.level.mistakes)),m(oe,ee)}),n(f);var G=h(f,2),H=_(G);ot(H,{get level_data(){return t(d)},get level_stats(){return e.level_stats}}),n(G),n(D);var be=h(D,2);be.__click=[wt,e];var De=h(be,2);De.__click=[jt,e],n(w),n(x),ue(1,C,()=>Ie,()=>({duration:3e3})),ue(3,w,()=>Ie),m(a,x)});var Ce=h(fe,2);S(Ce,()=>t(k)!==null,a=>{var x=zt(),w=_(x),C=_(w);S(C,()=>t(k)==="success",f=>{var E=ae(),G=R(E);Se(G,()=>t(c),H=>{Le(H,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),m(f,E)});var D=h(C,2);S(D,()=>t(k)==="failure",f=>{var E=ae(),G=R(E);Se(G,()=>t(c),H=>{Le(H,{count:5,items:["🦜","⁉","❔","❌"]})}),m(f,E)}),n(w),n(x),u(()=>j(w,"transform",`translate3d(${t(X)??""}px, ${t(ie)??""}px, 0)`)),m(a,x)}),n(F),n(M),u(()=>{te(M,"initial",t(re)),te(F,"success",t(A)),te(F,"failure",t(L)),te(F,"complete",t(N))}),nt(M,"clientWidth",a=>T(v,a)),m(b,p),V()}Me(["click"]);var St=y('<div class="level svelte-1jfpjrg"><!></div>'),Lt=y('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Mt=y('<main class="svelte-1jfpjrg"><!> <!></main>');function Gt(b,e){Q(e,!0);const s=Ke.get(),g=i(()=>{var r;return(r=s.selected_project_data)==null?void 0:r.level_stats});var v=Mt();Re(r=>{Xe.title="Earbetter trainer level"});var d=_(v);_t(d,{get onclick(){return s.exit_level}});var z=h(d,2);S(z,()=>s.level&&t(g),r=>{var l=St(),o=_(l);Bt(o,{get level(){return s.level},get level_stats(){return t(g)},get exit_level(){return s.exit_level}}),n(l),m(r,l)},r=>{var l=Lt(),o=_(l),c=h(_(o));c.__click=function(...k){var P;(P=s.exit_level)==null||P.apply(this,k)},Ye(),n(o),n(l),m(r,l)}),n(v),m(b,v),V()}Me(["click"]);export{Gt as component};
