import"../chunks/DsnmJJEf.js";import{v as qe,w as Ye,o as pe,aq as $e,B as et,C as tt,D as at,F as lt,J as st,U as it,I as rt,p as le,f as h,d as v,t as M,b as u,s as x,r as n,i as a,j as m,c as se,k as ve,a as O,ad as Ne,Q as K,$ as P,e as ge,a3 as Ae,_ as je,u as ze,ar as Ie,a1 as nt,a2 as vt,a4 as _t,a5 as ot,n as ct}from"../chunks/CJaerUHp.js";import{i as L,p as z}from"../chunks/C-YpJhoF.js";import{e as me,c as C,l as fe,s as V,b as Be,p as dt}from"../chunks/yq475m88.js";import{t as ae,v as ut,G as gt,x as te,y as mt,z as ft,f as Ee,k as xt,n as Se,q as Le,w as Me,i as bt,s as H,A as Te,B as Ke}from"../chunks/1gEw6I4J.js";import{M as ht,b as yt,P as kt,B as wt}from"../chunks/B077m1lY.js";import{b as Pe}from"../chunks/DEPAWzjT.js";import{L as qt}from"../chunks/VM_Ofw0m.js";function Ce(b,e,i){qe&&Ye();var g=b,_=it,c,y,d=null,o=$e;function l(){c&&rt(c),d!==null&&(d.lastChild.remove(),g.before(d),d=null),c=y}pe(()=>{if(o(_,_=e())){var s=g,r=lt();r&&(d=document.createDocumentFragment(),d.append(s=et())),y=tt(()=>i(s)),r?at.add_callback(l):l()}}),qe&&(g=st)}var jt=h('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),zt=h('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function It(b,e){le(e,!0);const i=(o,l,s,r)=>o==="complete"?"var(--lighten_5)":s[r]?l&&r===l.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",g=m(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var _=zt();let c;var y=v(_);me(y,17,()=>({length:e.level.level_data.trial_count}),fe,(o,l,s)=>{var r=jt();let q;M(k=>q=C(r,"",q,k),[()=>({"background-color":i(e.level.status,e.level.trial,e.level.trials,s)})]),u(o,r)});var d=x(y,2);V(d,"aria-valuemin",0),V(d,"aria-valuemax",100),n(_),M((o,l)=>{c=C(_,"",c,o),V(d,"aria-valuenow",l)},[()=>({"--progress_bar_percent":a(g)}),()=>Math.floor(a(g)*100)]),u(b,_),se()}var Bt=h('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),St=h('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function Lt(b,e){le(e,!0);const i=m(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),g=(o,l,s)=>o==="showing_failure_feedback"?"transparent":o==="complete"||o==="showing_success_feedback"?"var(--lighten_4)":l===s?"var(--lighten_3)":s!==null&&l<s?"var(--lighten_2)":"transparent",_=m(()=>e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:e.level.trial?.presenting_index!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:e.level.trial?.guessing_index!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0);var c=ve(),y=O(c);{var d=o=>{var l=St();let s;var r=v(l);me(r,17,()=>({length:e.level.trial.sequence.length}),fe,(k,T,D)=>{var F=Bt();let G;M(I=>G=C(F,"",G,I),[()=>({"background-color":g(e.level.status,D,a(i))})]),u(k,F)});var q=x(r,2);V(q,"aria-valuemin",0),V(q,"aria-valuemax",100),n(l),M((k,T)=>{s=C(l,"",s,k),V(q,"aria-valuenow",T)},[()=>({"--progress_bar_percent":a(_)}),()=>Math.floor(a(_)*100)]),ae(3,l,()=>ut),u(o,l)};L(y,o=>{e.level.trial&&o(d)})}u(b,c),se()}var Mt=h('<div class="burst-item svelte-zx8aeo"> </div>'),Tt=h('<div class="burst svelte-zx8aeo"></div>');function De(b,e){le(e,!0);const i=z(e,"duration",3,2e3),g=z(e,"x_radius",3,250),_=z(e,"y_radius",3,250),c=z(e,"scale_min",3,1),y=z(e,"scale_max",3,gt),d=z(e,"hue_rotation_min",3,0),o=z(e,"hue_rotation_max",3,0),l=z(e,"start_rotation_min",3,0),s=z(e,"start_rotation_max",3,359),r=z(e,"end_rotation_min",3,0),q=z(e,"end_rotation_max",3,359);let k=P(!1),T;Ne(()=>(T=setTimeout(()=>K(k,!0),i()),()=>clearTimeout(T)));var D=ve(),F=O(D);{var G=I=>{var N=Tt();let X;me(N,21,()=>({length:e.count}),fe,(R,xe)=>{var U=Mt();let W;var _e=v(U,!0);n(U),M((ie,re)=>{W=C(U,"",W,ie),ge(_e,re)},[()=>({"--target_x":`${te(-g(),g())??""}px`,"--target_y":`${te(-_(),_())??""}px`,"--scale":mt(c(),y()),"--start_rotation":`${te(l(),s())??""}deg`,"--end_rotation":`${te(r(),q())??""}deg`,"--hue_rotation":`${te(d(),o())??""}deg`}),()=>ft(e.items)]),u(R,U)}),n(N),M(R=>X=C(N,"",X,R),[()=>({"--animation_timer":`${i()??""}ms`})]),u(I,N)};L(F,I=>{a(k)||I(G)})}u(b,D),se()}const Kt=(b,e,i)=>{b.target===a(e)&&i.level.retry_trial()};var Pt=h('<div class="font_size_xl3 text_align_center">flawless run!</div>'),Ct=h('<div class="font_size_xl3"> </div> <div> </div>',1),Dt=(b,e)=>e.exit_level(),Nt=(b,e)=>e.level.reset(),At=h('<div class="completed_level_feedback svelte-1eux86c"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-1eux86c"><div class="box row"><div class="completed_header_icon svelte-1eux86c">â™«</div> <div class="completed_header_icon svelte-1eux86c">â™©<sup>â™ª</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),Et=h('<div class="feedback_text_bursts svelte-1eux86c"><div><!> <!></div></div>'),Ft=h('<!> <div aria-hidden="true"><div class="level_progress svelte-1eux86c" title="level progress"><!></div> <div class="trial_progress svelte-1eux86c" title="trial progress"><!></div> <div class="piano_wrapper svelte-1eux86c"><!></div> <div><!> <!></div></div>',1);function Gt(b,e){le(e,!0);const i=Ee.get(),g=xt.get();let _=P(void 0);const c=m(()=>e.level.level_data),y=m(()=>e.level.trial?.guessing_index),d=m(()=>e.level.status==="presenting_prompt"?null:i.playing_notes),o=m(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Ne(()=>{e.level.start()});const l=t=>{console.log("press note key",t),e.level.guess(t)};let s=P(0),r=P(null);const q=m(()=>e.level.status==="waiting_for_input"),k=m(()=>e.level.status==="showing_success_feedback"),T=m(()=>e.level.status==="showing_failure_feedback"),D=m(()=>e.level.status==="complete");je(()=>{a(k)&&ze(F)}),je(()=>{a(T)&&ze(G)});const F=()=>{Ie(s),K(r,"success"),R()},G=()=>{Ie(s),K(r,"failure"),R()};let I=P(void 0),N=P(0),X=P(0);const R=()=>{if(!a(I))return;const t=e.level.last_guess;if(t===null)return;const f=a(I).querySelector(`[data-note="${t}"]`);if(!f)return;const w=f.getBoundingClientRect();K(N,w.x,!0),K(X,w.y+w.height/2)},xe=m(()=>a(q)&&a(y)===0),U=20;let W=P(void 0);const _e=t=>{if(!(bt(t.target)||t.ctrlKey||t.shiftKey||t.altKey||t.metaKey))switch(t.key){case"r":{H(t),e.level.reset();return}case" ":switch(e.level.status){case"complete":{H(t),e.exit_level();return}default:{H(t),e.level.retry_trial();return}}case"d":{H(t),e.level.guess_correctly();return}case"a":{H(t),e.level.guess_incorrectly();return}case"w":{H(t),e.level.win();return}}};var ie=Ft();nt("keydown",vt,_e,!0);var re=O(ie);ht(re,{get midi_access(){return i.midi_access},onnotestart:(t,f)=>{e.level.status==="complete"?Le(i,g(),t,Me(i.volume,f),i.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(t))},onnotestop:t=>{Se(t)}});var J=x(re,2);let be;J.__click=[Kt,W,e];var oe=v(J),Fe=v(oe);It(Fe,{get level(){return e.level}}),n(oe);var ce=x(oe,2),Ge=v(ce);Lt(Ge,{get level(){return e.level}}),n(ce);var Y=x(ce,2);C(Y,"",{},{padding:"20px"});var Re=v(Y);{var Ue=t=>{{let f=m(()=>a(_)-U*2),w=m(()=>e.level.trial?.valid_notes),B=m(()=>e.level.status==="waiting_for_input"?S=>l(S):e.level.status==="complete"?S=>Le(i,g(),S,Me(i.volume,null),i.instrument):void 0),A=m(()=>e.level.status==="complete"?S=>Se(S):void 0);kt(t,{get width(){return a(f)},get min_note(){return a(c).min_note},get max_note(){return a(c).max_note},get enabled_notes(){return a(w)},get pressed_keys(){return a(d)},get highlighted_keys(){return a(o)},get onpress(){return a(B)},get onrelease(){return a(A)}})}};L(Re,t=>{a(_)&&t(Ue)})}n(Y),Pe(Y,t=>K(I,t),()=>a(I));var de=x(Y,2);let he;var ye=v(de);{var We=t=>{var f=At(),w=v(f),B=v(w),A=v(B),S=x(A,2);n(B);var p=x(B,2),$=v(p),j=v($);{var E=Z=>{var ne=Pt();u(Z,ne)},ee=Z=>{var ne=Ct(),ue=O(ne),Oe=v(ue,!0);n(ue);var we=x(ue,2),Ve=v(we);n(we),M(Xe=>{ge(Oe,e.level.mistakes),ge(Ve,`mistake${Xe??""} this run`)},[()=>dt(e.level.mistakes)]),u(Z,ne)};L(j,Z=>{e.level.mistakes===0?Z(E):Z(ee,!1)})}n($);var Q=x($,2),Ze=v(Q);qt(Ze,{get level_data(){return a(c)},get level_stats(){return e.level_stats}}),n(Q),n(p);var ke=x(p,2);ke.__click=[Dt,e];var He=x(ke,2);He.__click=[Nt,e],n(w),n(f),ae(1,A,()=>Te,()=>({duration:4e3,x:-200})),ae(1,S,()=>Te,()=>({duration:4e3,x:200})),ae(1,B,()=>Ke,()=>({duration:3e3})),ae(3,w,()=>Ke),u(t,f)};L(ye,t=>{a(D)&&t(We)})}var Je=x(ye,2);{var Qe=t=>{var f=Et(),w=v(f);let B;var A=v(w);{var S=j=>{var E=ve(),ee=O(E);Ce(ee,()=>a(s),Q=>{De(Q,{count:11,items:["ðŸŽµ","ðŸŽ¶","ðŸŒ¸","ðŸŒ»","ðŸŒ¼","ðŸ€"]})}),u(j,E)};L(A,j=>{a(r)==="success"&&j(S)})}var p=x(A,2);{var $=j=>{var E=ve(),ee=O(E);Ce(ee,()=>a(s),Q=>{De(Q,{count:5,items:["ðŸ¦œ","â‰","â”","âŒ"]})}),u(j,E)};L(p,j=>{a(r)==="failure"&&j($)})}n(w),n(f),M(j=>B=C(w,"",B,j),[()=>({transform:`translate3d(${a(N)??""}px, ${a(X)??""}px, 0)`})]),u(t,f)};L(Je,t=>{a(r)!==null&&t(Qe)})}n(de),n(J),Pe(J,t=>K(W,t),()=>a(W)),M((t,f)=>{be=Be(J,1,"level svelte-1eux86c",null,be,t),he=Be(de,1,"feedback svelte-1eux86c",null,he,f)},[()=>({initial:a(xe)}),()=>({success:a(k),failure:a(T),complete:a(D)})]),yt(J,"clientWidth",t=>K(_,t)),u(b,ie),se()}Ae(["click"]);var Rt=h('<div class="level svelte-1jfpjrg"><!></div>'),Ut=h('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Wt=h('<main class="svelte-1jfpjrg"><!> <!></main>');function pt(b,e){le(e,!0);const i=Ee.get(),g=m(()=>i.selected_project_data?.level_stats);var _=Wt();_t(l=>{ot.title="Earbetter trainer level"});var c=v(_);wt(c,{get onclick(){return i.exit_level}});var y=x(c,2);{var d=l=>{var s=Rt(),r=v(s);Gt(r,{get level(){return i.level},get level_stats(){return a(g)},get exit_level(){return i.exit_level}}),n(s),u(l,s)},o=l=>{var s=Ut(),r=v(s),q=x(v(r));q.__click=function(...k){i.exit_level?.apply(this,k)},ct(),n(r),n(s),u(l,s)};L(y,l=>{i.level&&a(g)?l(d):l(o,!1)})}n(_),u(b,_),se()}Ae(["click"]);export{pt as component};
