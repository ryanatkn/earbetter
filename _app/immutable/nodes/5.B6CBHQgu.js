import{t as b,a as c,c as de,s as fe,d as Ee,e as Ye,h as pe}from"../chunks/D6FQBtKd.js";import{i as qe,j as $e,h as et,aG as tt,x as at,w as lt,y as st,U as it,p as se,c as v,t as M,s as f,a as r,g as a,b as u,d as ie,f as F,_ as Re,G as K,V as P,T as ze,u as Ie,aH as Be,$ as rt,X as nt,n as vt}from"../chunks/Drfw-9es.js";import{i as L,p as z}from"../chunks/CnDERkxj.js";import{e as xe,d as N,i as be,s as J,c as Se,p as _t}from"../chunks/wr1Q2OBW.js";import{t as le,u as ot,G as dt,v as ae,x as ct,y as ut,f as Ue,j as mt,n as Te,o as Le,w as Me,i as gt,s as Z,A as Ge,B as Ke}from"../chunks/HpLCJ4lA.js";import{M as ft,b as xt,P as bt,B as ht}from"../chunks/DdIYz--E.js";import{b as Pe}from"../chunks/BIJQOs6A.js";import{L as yt}from"../chunks/BMtwy56f.js";function Ne(x,e,s){qe&&$e();var m=x,_=it,d,k=tt;et(()=>{k(_,_=e())&&(d&&at(d),d=lt(()=>s(m)))}),qe&&(m=st)}var kt=b('<div class="level svelte-99rq2n" aria-hidden="true"></div>'),wt=b('<div class="level_progress_indicator svelte-99rq2n"><!> <div class="progress_bar" aria-label="level progress"></div></div>');function jt(x,e){se(e,!0);const s=(n,l,i,o)=>n==="complete"?"var(--lighten_5)":i[o]?l&&o===l.index?"var(--lighten_4)":"var(--lighten_2)":"transparent",m=u(()=>e.level.status==="complete"?1:e.level.trial?(e.level.trial.index+.5)/e.level.level_data.trial_count:0);var _=wt();let d;var k=v(_);xe(k,17,()=>({length:e.level.level_data.trial_count}),be,(n,l,i)=>{var o=kt();let w;M(h=>w=N(o,"",w,{"background-color":h}),[()=>s(e.level.status,e.level.trial,e.level.trials,i)]),c(n,o)});var q=f(k,2);J(q,"aria-valuemin",0),J(q,"aria-valuemax",100),r(_),M(n=>{d=N(_,"",d,{"--progress_bar_percent":a(m)}),J(q,"aria-valuenow",n)},[()=>Math.floor(a(m)*100)]),c(x,_),ie()}var qt=b('<div class="trial svelte-1jf8emz" aria-hidden="true"></div>'),zt=b('<div class="trial_progress_indicator svelte-1jf8emz"><!> <div class="progress_bar svelte-1jf8emz" aria-label="trial progress"></div></div>');function It(x,e){se(e,!0);const s=u(()=>e.level.trial?e.level.trial.presenting_index??e.level.trial.guessing_index:null),m=(n,l,i)=>n==="showing_failure_feedback"?"transparent":n==="complete"||n==="showing_success_feedback"?"var(--lighten_4)":l===i?"var(--lighten_3)":i!==null&&l<i?"var(--lighten_2)":"transparent",_=u(()=>{var n,l;return e.level.status==="initial"||e.level.status==="showing_failure_feedback"?0:e.level.status==="complete"||e.level.status==="showing_success_feedback"?1:((n=e.level.trial)==null?void 0:n.presenting_index)!=null?(e.level.trial.presenting_index+.5)/e.level.trial.sequence.length:((l=e.level.trial)==null?void 0:l.guessing_index)!=null?(e.level.trial.guessing_index+.5)/e.level.trial.sequence.length:0});var d=de(),k=F(d);{var q=n=>{var l=zt();let i;var o=v(l);xe(o,17,()=>({length:e.level.trial.sequence.length}),be,(h,B,A)=>{var C=qt();let D;M(I=>D=N(C,"",D,{"background-color":I}),[()=>m(e.level.status,A,a(s))]),c(h,C)});var w=f(o,2);J(w,"aria-valuemin",0),J(w,"aria-valuemax",100),r(l),M(h=>{i=N(l,"",i,{"--progress_bar_percent":a(_)}),J(w,"aria-valuenow",h)},[()=>Math.floor(a(_)*100)]),le(3,l,()=>ot),c(n,l)};L(k,n=>{e.level.trial&&n(q)})}c(x,d),ie()}var Bt=b('<div class="burst-item svelte-zx8aeo"> </div>'),St=b('<div class="burst svelte-zx8aeo"></div>');function Ae(x,e){se(e,!0);const s=z(e,"duration",3,2e3),m=z(e,"x_radius",3,250),_=z(e,"y_radius",3,250),d=z(e,"scale_min",3,1),k=z(e,"scale_max",3,dt),q=z(e,"hue_rotation_min",3,0),n=z(e,"hue_rotation_max",3,0),l=z(e,"start_rotation_min",3,0),i=z(e,"start_rotation_max",3,359),o=z(e,"end_rotation_min",3,0),w=z(e,"end_rotation_max",3,359);let h=P(!1),B;Re(()=>(B=setTimeout(()=>K(h,!0),s()),()=>clearTimeout(B)));var A=de(),C=F(A);{var D=I=>{var E=St();let O;xe(E,21,()=>({length:e.count}),be,(re,he)=>{var R=Bt();let H;var ce=v(R,!0);r(R),M((ne,ve,G,_e,Q,ue,Y)=>{H=N(R,"",H,{"--target_x":`${ne??""}px`,"--target_y":`${ve??""}px`,"--scale":G,"--start_rotation":`${_e??""}deg`,"--end_rotation":`${Q??""}deg`,"--hue_rotation":`${ue??""}deg`}),fe(ce,Y)},[()=>ae(-m(),m()),()=>ae(-_(),_()),()=>ct(d(),k()),()=>ae(l(),i()),()=>ae(o(),w()),()=>ae(q(),n()),()=>ut(e.items)]),c(re,R)}),r(E),M(()=>O=N(E,"",O,{"--animation_timer":`${s()??""}ms`})),c(I,E)};L(C,I=>{a(h)||I(D)})}c(x,A),ie()}const Tt=(x,e,s)=>{x.target===a(e)&&s.level.retry_trial()};var Lt=b('<div class="size_xl3 text_align_center">flawless run!</div>'),Mt=b('<div class="size_xl3"> </div> <div> </div>',1),Gt=(x,e)=>e.exit_level(),Kt=(x,e)=>e.level.reset(),Pt=b('<div class="completed_level_feedback svelte-16m1rsw"><div class="pane shadow_d_xl p_xl3 pt_0 box svelte-16m1rsw"><div class="box row"><div class="completed_header_icon svelte-16m1rsw">♫</div> <div class="completed_header_icon svelte-16m1rsw">♩<sup>♪</sup></div></div> <div class="panel p_md mb_md box w_100"><div class="panel p_md mb_md box"><!></div> <div class="panel p_md"><!></div></div> <button type="button" class="big mb_md">go back to the map &nbsp;<code>Space</code></button> <button type="button" class="big">replay level &nbsp;<code>r</code></button></div></div>'),Nt=b('<div class="feedback_text_bursts svelte-16m1rsw"><div><!> <!></div></div>'),At=b('<!> <div aria-hidden="true"><div class="level_progress svelte-16m1rsw" title="level progress"><!></div> <div class="trial_progress svelte-16m1rsw" title="trial progress"><!></div> <div class="piano_wrapper svelte-16m1rsw"><!></div> <div><!> <!></div></div>',1);function Et(x,e){se(e,!0);const s=Ue.get(),m=mt.get();let _=P(void 0);const d=u(()=>e.level.level_data),k=u(()=>{var t;return(t=e.level.trial)==null?void 0:t.guessing_index}),q=u(()=>e.level.status==="presenting_prompt"?null:s.playing_notes),n=u(()=>e.level.trial&&new Set([e.level.trial.sequence[0]]));Re(()=>{e.level.start()});const l=t=>{console.log("press note key",t),e.level.guess(t)};let i=P(0),o=P(null);const w=u(()=>e.level.status==="waiting_for_input"),h=u(()=>e.level.status==="showing_success_feedback"),B=u(()=>e.level.status==="showing_failure_feedback"),A=u(()=>e.level.status==="complete");ze(()=>{a(h)&&Ie(C)}),ze(()=>{a(B)&&Ie(D)});const C=()=>{Be(i),K(o,"success"),re()},D=()=>{Be(i),K(o,"failure"),re()};let I=P(void 0),E=P(0),O=P(0);const re=()=>{if(!a(I))return;const t=e.level.last_guess;if(t===null)return;const g=a(I).querySelector(`[data-note="${t}"]`);if(!g)return;const y=g.getBoundingClientRect();K(E,y.x,!0),K(O,y.y+y.height/2)},he=u(()=>a(w)&&a(k)===0),R=20;let H=P(void 0);const ce=t=>{if(!(gt(t.target)||t.ctrlKey||t.shiftKey||t.altKey||t.metaKey))switch(t.key){case"r":{Z(t),e.level.reset();return}case" ":switch(e.level.status){case"complete":{Z(t),e.exit_level();return}default:{Z(t),e.level.retry_trial();return}}case"d":{Z(t),e.level.guess_correctly();return}case"a":{Z(t),e.level.guess_incorrectly();return}case"w":{Z(t),e.level.win();return}}};var ne=At();Ye("keydown",rt,ce,!0);var ve=F(ne);ft(ve,{get midi_access(){return s.midi_access},onnotestart:(t,g)=>{e.level.status==="complete"?Le(s,m(),t,Me(s.volume,g),s.instrument):(console.log("guessing level.status",e.level.status),e.level.guess(t))},onnotestop:t=>{Te(t)}});var G=f(ve,2);let _e;G.__click=[Tt,H,e];var Q=v(G),ue=v(Q);jt(ue,{get level(){return e.level}}),r(Q);var Y=f(Q,2),We=v(Y);It(We,{get level(){return e.level}}),r(Y);var p=f(Y,2);N(p,"",{},{padding:`${R}px`});var Ce=v(p);{var De=t=>{const g=u(()=>a(_)-R*2),y=u(()=>{var j;return(j=e.level.trial)==null?void 0:j.valid_notes}),S=u(()=>e.level.status==="waiting_for_input"?j=>l(j):e.level.status==="complete"?j=>Le(s,m(),j,Me(s.volume,null),s.instrument):void 0),U=u(()=>e.level.status==="complete"?j=>Te(j):void 0);bt(t,{get width(){return a(g)},get min_note(){return a(d).min_note},get max_note(){return a(d).max_note},get enabled_notes(){return a(y)},get pressed_keys(){return a(q)},get highlighted_keys(){return a(n)},get onpress(){return a(S)},get onrelease(){return a(U)}})};L(Ce,t=>{a(_)&&t(De)})}r(p),Pe(p,t=>K(I,t),()=>a(I));var me=f(p,2);let ye;var ke=v(me);{var He=t=>{var g=Pt(),y=v(g),S=v(y),U=v(S),j=f(U,2);r(S);var $=f(S,2),ee=v($),T=v(ee);{var W=X=>{var oe=Lt();c(X,oe)},te=X=>{var oe=Mt(),ge=F(oe),Je=v(ge,!0);r(ge);var je=f(ge,2),Oe=v(je);r(je),M(Qe=>{fe(Je,e.level.mistakes),fe(Oe,`mistake${Qe??""} this run`)},[()=>_t(e.level.mistakes)]),c(X,oe)};L(T,X=>{e.level.mistakes===0?X(W):X(te,!1)})}r(ee);var V=f(ee,2),Ze=v(V);yt(Ze,{get level_data(){return a(d)},get level_stats(){return e.level_stats}}),r(V),r($);var we=f($,2);we.__click=[Gt,e];var Fe=f(we,2);Fe.__click=[Kt,e],r(y),r(g),le(1,U,()=>Ge,()=>({duration:4e3,x:-200})),le(1,j,()=>Ge,()=>({duration:4e3,x:200})),le(1,S,()=>Ke,()=>({duration:3e3})),le(3,y,()=>Ke),c(t,g)};L(ke,t=>{a(A)&&t(He)})}var Ve=f(ke,2);{var Xe=t=>{var g=Nt(),y=v(g);let S;var U=v(y);{var j=T=>{var W=de(),te=F(W);Ne(te,()=>a(i),V=>{Ae(V,{count:11,items:["🎵","🎶","🌸","🌻","🌼","🍀"]})}),c(T,W)};L(U,T=>{a(o)==="success"&&T(j)})}var $=f(U,2);{var ee=T=>{var W=de(),te=F(W);Ne(te,()=>a(i),V=>{Ae(V,{count:5,items:["🦜","⁉","❔","❌"]})}),c(T,W)};L($,T=>{a(o)==="failure"&&T(ee)})}r(y),r(g),M(()=>S=N(y,"",S,{transform:`translate3d(${a(E)??""}px, ${a(O)??""}px, 0)`})),c(t,g)};L(Ve,t=>{a(o)!==null&&t(Xe)})}r(me),r(G),Pe(G,t=>K(H,t),()=>a(H)),M((t,g)=>{_e=Se(G,1,"level svelte-16m1rsw",null,_e,t),ye=Se(me,1,"feedback svelte-16m1rsw",null,ye,g)},[()=>({initial:a(he)}),()=>({success:a(h),failure:a(B),complete:a(A)})]),xt(G,"clientWidth",t=>K(_,t)),c(x,ne),ie()}Ee(["click"]);var Rt=b('<div class="level svelte-1jfpjrg"><!></div>'),Ut=b('<div class="box h_100"><p>No level found, <button type="button">go back</button> to the map.</p></div>'),Wt=b('<main class="svelte-1jfpjrg"><!> <!></main>');function Ot(x,e){se(e,!0);const s=Ue.get(),m=u(()=>{var l;return(l=s.selected_project_data)==null?void 0:l.level_stats});var _=Wt();pe(l=>{nt.title="Earbetter trainer level"});var d=v(_);ht(d,{get onclick(){return s.exit_level}});var k=f(d,2);{var q=l=>{var i=Rt(),o=v(i);Et(o,{get level(){return s.level},get level_stats(){return a(m)},get exit_level(){return s.exit_level}}),r(i),c(l,i)},n=l=>{var i=Ut(),o=v(i),w=f(v(o));w.__click=function(...h){var B;(B=s.exit_level)==null||B.apply(this,h)},vt(),r(o),r(i),c(l,i)};L(k,l=>{s.level&&a(m)?l(q):l(n,!1)})}r(_),c(x,_),ie()}Ee(["click"]);export{Ot as component};
