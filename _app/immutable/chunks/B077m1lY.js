import{g as re,u as ue,a3 as ee,p as J,f as U,i as a,j as m,d as F,r as P,t as N,a1 as p,b as y,c as V,l as Q,e as de,k as X,a as q,m as te,Q as G,$ as _e,a2 as O,a0 as fe,_ as he}from"./CJaerUHp.js";import"./DsnmJJEf.js";import{b as ne,s as A,c as ae,e as ge}from"./yq475m88.js";import{p as g,i as K}from"./C-YpJhoF.js";import{C as se,s as $,E as R,F as be,a as ke,b as me,H as ve}from"./1gEw6I4J.js";class Z{#e=new WeakMap;#t;#n;static entries=new WeakMap;constructor(e){this.#n=e}observe(e,t){var l=this.#e.get(e)||new Set;return l.add(t),this.#e.set(e,l),this.#a().observe(e,this.#n),()=>{var u=this.#e.get(e);u.delete(t),u.size===0&&(this.#e.delete(e),this.#t.unobserve(e))}}#a(){return this.#t??(this.#t=new ResizeObserver(e=>{for(var t of e){Z.entries.set(t.target,t);for(var l of this.#e.get(t.target)||[])l(t)}}))}}var ye=new Z({box:"border-box"});function Pe(f,e,t){var l=ye.observe(f,()=>t(f[e]));re(()=>(ue(()=>t(f[e])),l))}const we=(f,e)=>{let t=f.previousSibling;for(;t;){if(e(t))return t;t=t.previousSibling}return null},xe=(f,e)=>{let t=f.nextSibling;for(;t;){if(e(t))return t;t=t.nextSibling}return null};var Ie=U('<div class="middle_c svelte-sdpd33"><!></div>'),Me=U('<button type="button"><!></button>');function Te(f,e){J(e,!0);const t=g(e,"clickable",3,!0),l=g(e,"enabled",3,!0),u=g(e,"pressed",3,!1),b=g(e,"highlighted",3,!1),v=g(e,"emphasized",3,!1),i=g(e,"middle_c_label",3,!0),o=g(e,"allow_sticking",3,!1),c=m(()=>se.has(e.note)),h=m(()=>!a(c)),k=m(()=>e.note===60),d=n=>{we(n,z=>z instanceof HTMLButtonElement)?.focus()},I=n=>{xe(n,z=>z instanceof HTMLButtonElement)?.focus()},M=n=>{const{key:_}=n;switch(_){case" ":case"Enter":{$(n),e.onpress?.(e.note),n.currentTarget.focus();break}case"ArrowLeft":{d(n.currentTarget);break}case"ArrowRight":{I(n.currentTarget);break}}},T=n=>{const{key:_}=n;switch(_){case" ":case"Enter":{$(n),e.onrelease?.(e.note);break}}},r=m(()=>t()&&l());var s=Me();let w;s.__keydown=function(...n){(a(r)?M:void 0)?.apply(this,n)},s.__keyup=function(...n){(a(r)?T:void 0)?.apply(this,n)},s.__mousedown=function(...n){(a(r)?_=>{e.onpress?.(e.note),_.currentTarget.focus()}:void 0)?.apply(this,n)},s.__mouseup=function(...n){(a(r)?()=>{e.onrelease?.(e.note)}:void 0)?.apply(this,n)},s.__focusout=function(...n){(a(r)&&!o()?()=>{e.onrelease?.(e.note)}:void 0)?.apply(this,n)};let S;var E=F(s);{var D=n=>{var _=Ie(),z=F(_);{var W=x=>{var H=Q();N(()=>de(H,i())),y(x,H)},Y=x=>{var H=X(),ie=q(H);{var oe=L=>{var B=Q("C4");y(L,B)},le=L=>{var B=X(),ce=q(B);te(ce,i),y(L,B)};K(ie,L=>{typeof i()=="boolean"?L(oe):L(le,!1)},!0)}y(x,H)};K(z,x=>{typeof i()=="string"?x(W):x(Y,!1)})}P(_),y(n,_)};K(E,n=>{a(k)&&i()&&n(D)})}P(s),N((n,_)=>{w=ne(s,1,"piano_key svelte-sdpd33",null,w,n),A(s,"tabindex",a(r)?void 0:-1),A(s,"aria-label",`piano key for midi ${e.note??""}`),A(s,"data-note",e.note),S=ae(s,"",S,_)},[()=>({natural:a(c),accidental:a(h),disabled:!l(),clickable:a(r),active:u(),highlighted:b(),emphasized:v()}),()=>({left:`${e.left_offset??""}px`})]),p("mouseenter",s,function(...n){(a(r)&&e.pressing_any?_=>{e.onpress?.(e.note),_.currentTarget.focus()}:void 0)?.apply(this,n)}),p("mouseleave",s,function(...n){(a(r)?()=>{e.onrelease?.(e.note)}:void 0)?.apply(this,n)}),y(f,s),V()}ee(["keydown","keyup","mousedown","mouseup","focusout"]);const Ee=5,De=7/12,ze=.7,j={1:0,2:-3/5,3:0,4:-2/5,5:0,6:0,7:-2/3,8:0,9:-1/2,10:0,11:-1/3,12:0},Le=(f,e,t,l=500)=>{const u=Math.abs(j[R[e]]);let b=Math.abs(j[R[t]]);b&&(b=1-b);const v=t-e+1;if(v<=0)return{piano_keys:[],natural_key_height:l,natural_key_width:0,accidental_key_height:0,accidental_key_width:0};const i=be(e,t),o=f/(i.length+(u+b))|0,c=o*De|0,h=Math.min(l,c*Ee)|0,k=h*ze|0;let d=0;const I=[];for(let M=0;M<v;M++){const T=M+e;let r,s,w;se.has(T)?(r=o,s=h,w=d*o+u*c,d++):(r=c,s=k,w=d*o+j[R[T]]*c+u*c),I.push({note:T,left_offset:w,width:r,height:s})}return{piano_keys:I,natural_key_height:h,natural_key_width:o,accidental_key_height:k,accidental_key_width:c}};var Se=U("<div></div>");function Ne(f,e){J(e,!0);const t=g(e,"max_height",3,void 0),l=g(e,"min_note",3,ke),u=g(e,"max_note",3,me),b=g(e,"enabled_notes",3,null),v=g(e,"pressed_keys",3,null),i=g(e,"highlighted_keys",3,null),o=g(e,"emphasized_keys",3,null),c=g(e,"clickable",3,!0),h=m(()=>Le(e.width,l(),u(),t())),k=m(()=>a(h).piano_keys),d=m(()=>a(h).natural_key_width),I=m(()=>a(h).natural_key_height),M=m(()=>a(h).accidental_key_width),T=m(()=>a(h).accidental_key_height);let r=_e(!1);var s=Se();p("mousedown",O,()=>G(r,!0),!0),p("mouseup",O,()=>G(r,!1),!0),p("mouseleave",O,()=>G(r,!1));let w,S;ge(s,21,()=>a(k),({note:E,left_offset:D})=>E,(E,D)=>{let n=()=>a(D).note,_=()=>a(D).left_offset;{let z=m(()=>!b()||b().has(n())),W=m(()=>v()?.has(n())),Y=m(()=>i()?.has(n())),x=m(()=>o()?.has(n()));Te(E,{get note(){return n()},get left_offset(){return _()},get clickable(){return c()},get enabled(){return a(z)},get pressed(){return a(W)},get highlighted(){return a(Y)},get emphasized(){return a(x)},get middle_c_label(){return e.middle_c_label},get allow_sticking(){return e.allow_sticking},get pressing_any(){return a(r)},get onpress(){return e.onpress},get onrelease(){return e.onrelease}})}}),P(s),N((E,D)=>{w=ne(s,1,"piano svelte-d5674k",null,w,E),A(s,"aria-disabled",!c()),S=ae(s,"",S,D)},[()=>({disabled:!c()}),()=>({width:`${e.width??""}px`,height:`${a(I)??""}px`,"--piano_natural_key_width":`${a(d)??""}px`,"--piano_natural_key_height":`${a(I)??""}px`,"--piano_accidental_key_width":`${a(M)??""}px`,"--piano_accidental_key_height":`${a(T)??""}px`})]),y(f,s),V()}const C={Stop:8,Start:9,Knob:11,PitchBend:14};function Ue(f,e){J(e,!0);const t=console.log.bind(console),l=i=>{const o=ve(i),{command:c,channel:h,note:k,velocity:d}=o;switch(t("midimessage",c,o),c){case C.Stop:{h===0?e.onnotestop?.(k,d):h===9?e.onpadstop?.(k,d):t("unknown MIDI stop command",o);break}case C.Start:{h===0?d===0?e.onnotestop?.(k,d):e.onnotestart?.(k,d):h===9?d===0?e.onpadstop?.(k,d):e.onpadstart?.(k,d):t("unknown MIDI start command",o);break}case C.Knob:{k===1?e.onmodwheel?.(d):t("unknown MIDI knob command",o);break}case C.PitchBend:{t("unhandled MIDI pitch bend",o);break}default:t("unrecognized MIDI command",o)}},u=[],b=()=>{for(const i of u)i();u.length=0};fe(b);const v=i=>{if(u.length&&b(),!!i)for(const o of i.inputs.values())o.addEventListener("midimessage",l),u.push(()=>{o.removeEventListener("midimessage",l)})};he(()=>v(e.midi_access)),V()}var He=U('<button type="button" class="icon_button plain_button svelte-1otcvwf"><!></button>');function We(f,e){const t=g(e,"title",3,"go back");var l=He();l.__click=function(...i){e.onclick?.apply(this,i)};var u=F(l);{var b=i=>{var o=X(),c=q(o);te(c,()=>e.children),y(i,o)},v=i=>{var o=Q("←");y(i,o)};K(u,i=>{e.children?i(b):i(v,!1)})}P(l),N(()=>A(l,"title",t())),y(f,l)}ee(["click"]);export{We as B,Ue as M,Ne as P,Pe as b};
